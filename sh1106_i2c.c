/* 
 * SH1106 OLED DISPLAY DRIVER based on ssd1306_i2c.c file
 * available on: https://github.com/raspberrypi/pico-examples/tree/master/i2c/ssd1306_i2c
*/
/**
 * Copyright (c) 2021 Raspberry Pi (Trading) Ltd.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 * 
 * Redistribution and use in source and binary forms, with or without modification,
 * are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 * this list of conditions and the following disclaimer.
 * 
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 * this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
 *
 * 3. Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products
 * derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS
 * AND CONTRIBUTORS “AS IS” AND ANY EXPRESS OR IMPLIED
 * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
 * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
 * SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
 * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE
 * GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
 * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
 * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
 * DAMAGE.
 *  
 */

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <ctype.h>
#include "pico/stdlib.h"
#include "pico/binary_info.h"
#include "hardware/i2c.h"
#include "include/general.h"
#include "include/sh1106_i2c.h"

// max 10 characters with 12x16 pixel character format
static char *DISPLAY_DESCR[] = {
    "Realtime",
    "Last 24h T",
    "Last 24h H"
};

// in progress...
static char *DISPLAY_LAST24H[] = {
    "Min",
    "Max",
    "Avg",
};

static uint8_t font8[] = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // Nothing
0x78, 0x14, 0x12, 0x11, 0x12, 0x14, 0x78, 0x00, //A
0x7f, 0x49, 0x49, 0x49, 0x49, 0x49, 0x7f, 0x00, //B
0x7e, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x00, //C
0x7f, 0x41, 0x41, 0x41, 0x41, 0x41, 0x7e, 0x00, //D
0x7f, 0x49, 0x49, 0x49, 0x49, 0x49, 0x49, 0x00, //E
0x7f, 0x09, 0x09, 0x09, 0x09, 0x01, 0x01, 0x00, //F
0x7f, 0x41, 0x41, 0x41, 0x51, 0x51, 0x73, 0x00, //G
0x7f, 0x08, 0x08, 0x08, 0x08, 0x08, 0x7f, 0x00, //H
0x00, 0x00, 0x00, 0x7f, 0x00, 0x00, 0x00, 0x00, //I
0x21, 0x41, 0x41, 0x3f, 0x01, 0x01, 0x01, 0x00, //J
0x00, 0x7f, 0x08, 0x08, 0x14, 0x22, 0x41, 0x00, //K
0x7f, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x00, //L
0x7f, 0x02, 0x04, 0x08, 0x04, 0x02, 0x7f, 0x00, //M
0x7f, 0x02, 0x04, 0x08, 0x10, 0x20, 0x7f, 0x00, //N
0x3e, 0x41, 0x41, 0x41, 0x41, 0x41, 0x3e, 0x00, //O
0x7f, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0e, 0x00, //P
0x3e, 0x41, 0x41, 0x49, 0x51, 0x61, 0x7e, 0x00, //Q
0x7f, 0x11, 0x11, 0x11, 0x31, 0x51, 0x0e, 0x00, //R
0x46, 0x49, 0x49, 0x49, 0x49, 0x30, 0x00, 0x00, //S
0x01, 0x01, 0x01, 0x7f, 0x01, 0x01, 0x01, 0x00, //T
0x3f, 0x40, 0x40, 0x40, 0x40, 0x40, 0x3f, 0x00, //U
0x0f, 0x10, 0x20, 0x40, 0x20, 0x10, 0x0f, 0x00, //V
0x7f, 0x20, 0x10, 0x08, 0x10, 0x20, 0x7f, 0x00, //W
0x00, 0x41, 0x22, 0x14, 0x14, 0x22, 0x41, 0x00, //X
0x01, 0x02, 0x04, 0x78, 0x04, 0x02, 0x01, 0x00, //Y
0x41, 0x61, 0x59, 0x45, 0x43, 0x41, 0x00, 0x00, //Z
0x3e, 0x41, 0x41, 0x49, 0x41, 0x41, 0x3e, 0x00, //0
0x00, 0x00, 0x42, 0x7f, 0x40, 0x00, 0x00, 0x00, //1
0x30, 0x49, 0x49, 0x49, 0x49, 0x46, 0x00, 0x00, //2
0x49, 0x49, 0x49, 0x49, 0x49, 0x49, 0x36, 0x00, //3
0x3f, 0x20, 0x20, 0x78, 0x20, 0x20, 0x00, 0x00, //4
0x4f, 0x49, 0x49, 0x49, 0x49, 0x30, 0x00, 0x00, //5
0x3f, 0x48, 0x48, 0x48, 0x48, 0x48, 0x30, 0x00, //6
0x01, 0x01, 0x01, 0x61, 0x31, 0x0d, 0x03, 0x00, //7
0x36, 0x49, 0x49, 0x49, 0x49, 0x49, 0x36, 0x00, //8
0x06, 0x09, 0x09, 0x09, 0x09, 0x09, 0x7f, 0x00, //9
};

static uint8_t font_16p12[] = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  32  SPACE
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  33  !
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  34  "
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  35  #
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  36  $
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  37  %
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  38  &
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  39  '
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  40  (
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  41  )
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  42  *
0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x0f, 0x0f, 0x30, 0x30, 0x00, 0x00, 0x00, //  43  +
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, //  44  ,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x00, 0x00, 0x00, //  45  -
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, //  46  .
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  47  /
0x00, 0xfc, 0xfe, 0x06, 0x06, 0x06, 0xc6, 0x36, 0x0e, 0xfe, 0xfc, 0x00, 0x00, 0x3f, 0x7f, 0x78, 0x64, 0x63, 0x60, 0x60, 0x60, 0x7f, 0x3f, 0x00, //  48  0
0x00, 0x00, 0x00, 0x04, 0x06, 0xfe, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, //  49  1
0x00, 0x0c, 0x8e, 0x86, 0x86, 0x86, 0x86, 0x86, 0x86, 0xfe, 0xfc, 0x00, 0x00, 0x3f, 0x7f, 0x61, 0x61, 0x61, 0x61, 0x61, 0x61, 0x61, 0x60, 0x00, //  50  2
0x00, 0x0c, 0x0e, 0x06, 0x86, 0x86, 0x86, 0x86, 0x86, 0xfe, 0x7c, 0x00, 0x00, 0x30, 0x70, 0x60, 0x61, 0x61, 0x61, 0x61, 0x61, 0x7f, 0x3e, 0x00, //  51  3
0x00, 0x00, 0x80, 0xc0, 0x70, 0x1c, 0x06, 0xfe, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x1e, 0x1b, 0x18, 0x18, 0x18, 0x18, 0x7f, 0x7f, 0x18, 0x18, 0x00, //  52  4
0x00, 0xfc, 0xfe, 0x86, 0x86, 0x86, 0x86, 0x86, 0x86, 0x86, 0x04, 0x00, 0x00, 0x30, 0x71, 0x61, 0x61, 0x61, 0x61, 0x61, 0x61, 0x7f, 0x3f, 0x00, //  53  5
0x00, 0xfc, 0xfe, 0x86, 0x86, 0x86, 0x86, 0x86, 0x86, 0x8e, 0x0c, 0x00, 0x00, 0x3f, 0x7f, 0x61, 0x61, 0x61, 0x61, 0x61, 0x61, 0x7f, 0x3f, 0x00, //  54  6
0x00, 0x04, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0xfe, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x7f, 0x00, //  55  7
0x00, 0x7c, 0xfe, 0xc6, 0x86, 0x86, 0x86, 0x86, 0xc6, 0xfe, 0x7c, 0x00, 0x00, 0x3e, 0x7f, 0x63, 0x61, 0x61, 0x61, 0x61, 0x63, 0x7f, 0x3f, 0x00, //  56  8
0x00, 0xfc, 0xfe, 0x86, 0x86, 0x86, 0x86, 0x86, 0x86, 0xfe, 0xfc, 0x00, 0x00, 0x30, 0x71, 0x61, 0x61, 0x61, 0x61, 0x61, 0x61, 0x7f, 0x3f, 0x00, //  57  9
0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, //  58  :
0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, //  59  ;
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  60  <
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  61  =
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  62  >
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  63  ?
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  64  @
0x00, 0xfc, 0xfe, 0x86, 0x86, 0x86, 0x86, 0x86, 0x86, 0xfe, 0xfc, 0x00, 0x00, 0x7f, 0x7f, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x7f, 0x7f, 0x00, //  65  A
0x00, 0xfe, 0xfe, 0x86, 0x86, 0x86, 0x86, 0xc6, 0xfe, 0xbc, 0x00, 0x00, 0x00, 0x7f, 0x7f, 0x61, 0x61, 0x61, 0x61, 0x61, 0x61, 0x7f, 0x3f, 0x00, //  66  B
0x00, 0xfc, 0xfe, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x00, 0x00, 0x3f, 0x7f, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x00, //  67  C
0x00, 0xfe, 0xfe, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0xfe, 0xfc, 0x00, 0x00, 0x7f, 0x7f, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7f, 0x3f, 0x00, //  68  D
0x00, 0xfe, 0xfe, 0x86, 0x86, 0x86, 0x86, 0x86, 0x86, 0x06, 0x06, 0x00, 0x00, 0x7f, 0x7f, 0x61, 0x61, 0x61, 0x61, 0x61, 0x61, 0x60, 0x60, 0x00, //  69  E
0x00, 0xfe, 0xfe, 0x86, 0x86, 0x86, 0x86, 0x86, 0x86, 0x06, 0x06, 0x00, 0x00, 0x7f, 0x7f, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, //  70  F
0x00, 0xfc, 0xfe, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x0e, 0x0c, 0x00, 0x00, 0x3f, 0x7f, 0x60, 0x60, 0x60, 0x60, 0x60, 0x63, 0x7f, 0x3f, 0x00, //  71  G
0x00, 0xfe, 0xfe, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xfe, 0xfe, 0x00, 0x00, 0x7f, 0x7f, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x7f, 0x7f, 0x00, //  72  H
0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, //  73  I
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xfe, 0x00, 0x00, 0x30, 0x70, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7f, 0x3f, 0x00, //  74  J
0x00, 0xfe, 0xfe, 0x80, 0x80, 0xc0, 0xe0, 0x70, 0x38, 0x1c, 0x0e, 0x00, 0x00, 0x7f, 0x7f, 0x01, 0x01, 0x03, 0x07, 0x0e, 0x1c, 0x38, 0x70, 0x00, //  75  K
0x00, 0xfe, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x7f, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x00, //  76  L
0x00, 0xfe, 0xfe, 0x1c, 0x70, 0xc0, 0xc0, 0x70, 0x1c, 0xfe, 0xfe, 0x00, 0x00, 0x7f, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x7f, 0x00, //  77  M
0x00, 0xfe, 0xfe, 0x0e, 0x38, 0xe0, 0x00, 0x00, 0x00, 0xfe, 0xfe, 0x00, 0x00, 0x7f, 0x7f, 0x00, 0x00, 0x00, 0x07, 0x1c, 0x70, 0x7f, 0x7f, 0x00, //  78  N
0x00, 0xfc, 0xfe, 0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0xfe, 0xfc, 0x00, 0x00, 0x3f, 0x7f, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7f, 0x3f, 0x00, //  79  O
0x00, 0xfe, 0xfe, 0x86, 0x86, 0x86, 0x86, 0x86, 0x86, 0xfe, 0xfc, 0x00, 0x00, 0x7f, 0x7f, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, //  80  P
0x00, 0xfc, 0xfe, 0x06, 0x06, 0x06, 0x06, 0x06, 0xfe, 0xfc, 0x00, 0x00, 0x00, 0x3f, 0x7f, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7f, 0x7f, 0x60, 0x00, //  81  Q
0x00, 0xfe, 0xfe, 0x86, 0x86, 0x86, 0x86, 0x86, 0x86, 0xfe, 0xfc, 0x00, 0x00, 0x7f, 0x7f, 0x01, 0x01, 0x01, 0x03, 0x0f, 0x3d, 0x71, 0x60, 0x00, //  82  R
0x00, 0xfc, 0xfe, 0x86, 0x86, 0x86, 0x86, 0x86, 0x86, 0x8e, 0x0c, 0x00, 0x00, 0x30, 0x71, 0x61, 0x61, 0x61, 0x61, 0x61, 0x61, 0x7f, 0x3f, 0x00, //  83  S
0x00, 0x06, 0x06, 0x06, 0x06, 0xfe, 0xfe, 0x06, 0x06, 0x06, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, //  84  T
0x00, 0xfe, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xfe, 0x00, 0x00, 0x3f, 0x7f, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7f, 0x3f, 0x00, //  85  U
0x00, 0x0e, 0x7e, 0xf0, 0x80, 0x00, 0x00, 0x80, 0xf0, 0x7e, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x03, 0x1f, 0x78, 0x78, 0x1f, 0x03, 0x00, 0x00, 0x00, //  86  V
0x00, 0xfe, 0x00, 0x00, 0xfe, 0x00, 0x00, 0xfe, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x7f, 0x20, 0x10, 0x09, 0x06, 0x06, 0x09, 0x10, 0x20, 0x7f, 0x00, //  87  W
0x00, 0x06, 0x1e, 0x78, 0xe0, 0xc0, 0xc0, 0xe0, 0x78, 0x1e, 0x06, 0x00, 0x00, 0x60, 0x78, 0x1e, 0x07, 0x03, 0x03, 0x07, 0x1e, 0x78, 0x60, 0x00, //  88  X
0x00, 0x06, 0x1e, 0x78, 0xe0, 0x80, 0x80, 0xe0, 0x78, 0x1e, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x7f, 0x7f, 0x01, 0x00, 0x00, 0x00, 0x00, //  89  Y
0x00, 0x06, 0x06, 0x06, 0x06, 0x86, 0xc6, 0x76, 0x3e, 0x1e, 0x0e, 0x00, 0x00, 0x70, 0x78, 0x7c, 0x6e, 0x63, 0x61, 0x60, 0x60, 0x60, 0x60, 0x00, //  90  Z
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  91  [
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  92  "\"
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  93  ]
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  94  ^
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x00, //  95  _
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, //  96  `
0x00, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0xf8, 0xf0, 0x00, 0x00, 0x3f, 0x7f, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x7f, 0x7f, 0x00, //  97  a
0x00, 0xfe, 0xfe, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0xf8, 0xf0, 0x00, 0x00, 0x7f, 0x7f, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7f, 0x3f, 0x00, //  98  b
0x00, 0xf0, 0xf8, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x3f, 0x7f, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x00, //  99  c
0x00, 0xf0, 0xf8, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0xfe, 0xfe, 0x00, 0x00, 0x3f, 0x7f, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7f, 0x7f, 0x00, // 100  d
0x00, 0xf0, 0xf8, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0xf8, 0xf0, 0x00, 0x00, 0x3f, 0x7f, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x00, // 101  e
0x00, 0x00, 0x00, 0xfc, 0xfe, 0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 102  f
0x00, 0xf0, 0xf8, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0xf8, 0xf0, 0x00, 0x00, 0x03, 0x07, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x7f, 0x3f, 0x00, // 103  g
0x00, 0xfe, 0xfe, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0xf8, 0xf0, 0x00, 0x00, 0x7f, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x7f, 0x00, // 104  h
0x00, 0x00, 0x00, 0x00, 0x00, 0xe6, 0xe6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, // 105  i
0x00, 0x00, 0x00, 0x00, 0x00, 0xf6, 0xf6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x60, 0x60, 0x60, 0x7f, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, // 106  j
0x00, 0xfe, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x80, 0xc0, 0x60, 0x20, 0x00, 0x00, 0x7f, 0x7f, 0x06, 0x06, 0x06, 0x0f, 0x09, 0x30, 0x60, 0x40, 0x00, // 107  k
0x00, 0x00, 0x00, 0x00, 0xfe, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x7f, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00, // 108  l
0x00, 0xf8, 0xf8, 0x18, 0x18, 0xf8, 0xf8, 0x18, 0x18, 0xf8, 0xf0, 0x00, 0x00, 0x7f, 0x7f, 0x00, 0x00, 0x7f, 0x7f, 0x00, 0x00, 0x7f, 0x7f, 0x00, // 109  m
0x00, 0x00, 0xf8, 0xf8, 0x18, 0x18, 0x18, 0x18, 0xf8, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x7f, 0x00, 0x00, // 110  n
0x00, 0xf0, 0xf8, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0xf8, 0xf0, 0x00, 0x00, 0x3f, 0x7f, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7f, 0x3f, 0x00, // 111  o
0x00, 0xf8, 0xf8, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0xf8, 0xf0, 0x00, 0x00, 0x7f, 0x7f, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x1f, 0x0f, 0x00, // 112  p
0x00, 0xf0, 0xf8, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0xf8, 0xf8, 0x00, 0x00, 0x0f, 0x1f, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x7f, 0x7f, 0x00, // 113  q
0x00, 0x00, 0xf0, 0xf8, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 114  r
0x00, 0xf0, 0xf8, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x38, 0x30, 0x00, 0x00, 0x31, 0x73, 0x63, 0x63, 0x63, 0x63, 0x63, 0x63, 0x7f, 0x3e, 0x00, // 115  s
0x00, 0x00, 0x00, 0xfe, 0xfe, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x7f, 0x60, 0x60, 0x60, 0x60, 0x00, 0x00, 0x00, // 116  t
0x00, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xf8, 0x00, 0x00, 0x3f, 0x7f, 0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7f, 0x3f, 0x00, // 117  u
0x00, 0x18, 0x78, 0xe0, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x78, 0x18, 0x00, 0x00, 0x00, 0x00, 0x03, 0x1f, 0x78, 0x78, 0x1f, 0x03, 0x00, 0x00, 0x00, // 118  v
0x00, 0x38, 0xc0, 0x00, 0xc0, 0x38, 0x38, 0xc0, 0x00, 0xc0, 0x38, 0x00, 0x00, 0x00, 0x07, 0x78, 0x07, 0x00, 0x00, 0x07, 0x78, 0x07, 0x00, 0x00, // 119  w
0x00, 0x18, 0x38, 0xf0, 0xc0, 0x00, 0x00, 0xc0, 0xf0, 0x38, 0x18, 0x00, 0x00, 0x60, 0x70, 0x3c, 0x0f, 0x03, 0x03, 0x0f, 0x3c, 0x70, 0x60, 0x00, // 120  x
0x00, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xf8, 0x00, 0x00, 0x03, 0x07, 0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x7f, 0x3f, 0x00, // 121  y
0x00, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0xf8, 0x78, 0x38, 0x00, 0x00, 0x60, 0x70, 0x78, 0x6c, 0x66, 0x63, 0x61, 0x60, 0x60, 0x00, 0x00, // 122  z
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 123  {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 124  |
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 125  }
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 126  ~
};

static uint8_t icons_16p12[] = {
0x00, 0x0c, 0x12, 0x12, 0x0c, 0x00, 0xf8, 0xfc, 0x0e, 0x06, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x7f, 0x70, 0x60, 0x60, 0x00, //  °C
0x00, 0x0c, 0x12, 0x12, 0x0c, 0x00, 0xf7, 0xf7, 0xc6, 0xc6, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x7f, 0x00, 0x00, 0x00, 0x00, //  °F
0x00, 0x0c, 0x12, 0x12, 0x0c, 0x80, 0xe0, 0xf0, 0x3c, 0x1e, 0x06, 0x00, 0,00, 0x60, 0x78, 0x3c, 0x0f, 0x07, 0x01, 0x30, 0x48, 0x48, 0x30, 0x00, //  %
0x00, 0x00, 0x00, 0x00, 0xfc, 0x82, 0x82, 0xfc, 0x00, 0x50, 0x50, 0x00, 0x00, 0x00, 0x18, 0x3c, 0x7f, 0x7f, 0x7f, 0x7f, 0x3c, 0x19, 0x01, 0x00, //  termometer
0x00, 0x80, 0xc0, 0x70, 0xf8, 0xfe, 0xfe, 0xf8, 0xf0, 0xc0, 0x80, 0x00, 0x00, 0x03, 0x07, 0x1e, 0x38, 0x63, 0x6f, 0x3f, 0x1f, 0x07, 0x03, 0x00, //  drop of water
0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0xf0, 0xf0, 0x00, 0xfe, 0xfe, 0x00, 0x00, 0x70, 0x00, 0x7f, 0x7f, 0x00, 0x7f, 0x7f, 0x00, 0x7f, 0x7f, 0x00, //  wifi connected
};

/* Example code to talk to an SH1106-based OLED display

   The SH1106 is an OLED/PLED driver chip, capable of driving displays up to
   128x64 pixels.

   NOTE: Ensure the device is capable of being driven at 3.3v NOT 5v. The Pico
   GPIO (and therefore I2C) cannot be used at 5v.

   You will need to use a level shifter on the I2C lines if you want to run the
   board at 5v.

   Connections on Raspberry Pi Pico board, other boards may vary.

   GPIO PICO_DEFAULT_I2C_SDA_PIN (on Pico this is GP4 (pin 6)) -> SDA on display
   board
   GPIO PICO_DEFAULT_I2C_SCL_PIN (on Pico this is GP5 (pin 7)) -> SCL on
   display board
   3.3v (pin 36) -> VCC on display board
   GND (pin 38)  -> GND on display board
*/



void SH1106_send_cmd(uint8_t cmd)
{
    // I2C write process expects a control byte followed by data
    // this "data" can be a command or data to follow up a command
    // Co = 1, D/C = 0 => the driver expects a command
    uint8_t buf[2] = {0x80, cmd};
    i2c_write_blocking(i2c_default, SH1106_I2C_ADDR, buf, 2, false);
}

void SH1106_send_cmd_list(uint8_t *buf, int num)
{
    for (int i=0;i<num;i++)
        SH1106_send_cmd(buf[i]);
}

void SH1106_send_buf(uint8_t buf[], int buflen)
{
    // in horizontal addressing mode, the column address pointer auto-increments
    // and then wraps around to the next page, so we can send the entire frame
    // buffer in one gooooooo!

    // copy our frame buffer into a new buffer because we need to add the control byte
    // to the beginning

    uint8_t *temp_buf = malloc(buflen + 1);

    temp_buf[0] = 0x40;
    memcpy(temp_buf+1, buf, buflen);

    i2c_write_blocking(i2c_default, SH1106_I2C_ADDR, temp_buf, buflen + 1, false);

    free(temp_buf);
}

void SH1106_init()
{
    // Some of these commands are not strictly necessary as the reset
    // process defaults to some of these but they are shown here
    // to demonstrate what the initialization sequence looks like
    // Some configuration values are recommended by the board manufacturer

    uint8_t cmds[] = {
        SH1106_SET_DISP_OFF,               // set display off
        /* timing and driving scheme */
        SH1106_SET_DISP_CLK_DIV,       // set display clock divide ratio
        0x80,                           // div ratio of 1, standard freq
        SH1106_SET_MUX_RATIO,          // set multiplex ratio
        0x3F,
        SH1106_SET_DISP_OFFSET,        // set display offset
        0x00,                           // no offset
        SH1106_SET_DISP_START_LINE,    // set display start line to 0
        SH1106_SET_CHARGE_PUMP,        // set charge pump
        0x14,                           // Vcc internally generated on our board
        SH1106_SET_MEM_MODE,           // set memory address mode 0 = horizontal, 1 = vertical, 2 = page
        0x00,                           // horizontal addressing mode
        /* resolution and layout */
        SH1106_SET_SEG_REMAP | 0x01,   // set segment re-map, column address 127 is mapped to SEG0
        SH1106_SET_COM_OUT_DIR | 0x08, // set COM (common) output scan direction. Scan from bottom up, COM[N-1] to COM0
        SH1106_SET_COM_PIN_CFG,        // set COM (common) pins hardware configuration. Board specific magic number.
                                        // 0x02 Works for 128x32, 0x12 Possibly works for 128x64. Other options 0x22, 0x32
#if ((SH1106_WIDTH == 128) && (SH1106_HEIGHT == 32))
        0x02,
#elif ((SH1106_WIDTH == 128) && (SH1106_HEIGHT == 64))
        0x12,
#else
        0x02,
#endif
        /* display */
        SH1106_SET_CONTRAST,           // set contrast control
        0xFF,
        SH1106_SET_PRECHARGE,          // set pre-charge period
        0xF1,                           // Vcc internally generated on our board
        SH1106_SET_VCOM_DESEL,         // set VCOMH deselect level
        0x40,                           // 0.83xVcc
        SH1106_SET_ENTIRE_ON,          // set entire display on to follow RAM content
        SH1106_SET_NORM_DISP,           // set normal (not inverted) display
//        SH1106_HEIGHT - 1,             // Display height - 1
//        SH1106_SET_SCROLL | 0x00,      // deactivate horizontal scrolling if set. This is necessary as memory writes will corrupt if scrolling was enabled
        SH1106_SET_DISP_ON,             // turn display on
    };

    SH1106_send_cmd_list(cmds, count_of(cmds));
}

void SH1106_scroll(bool on)
{
    // configure horizontal scrolling
    uint8_t cmds[] = {
        SH1106_SET_HORIZ_SCROLL | 0x00,
        0x00, // dummy byte
        0x00, // start page 0
        0x00, // time interval
        0x03, // end page 3 SH1106_NUM_PAGES ??
        0x00, // dummy byte
        0xFF, // dummy byte
        SH1106_SET_SCROLL | (on ? 0x01 : 0) // Start/stop scrolling
    };

    SH1106_send_cmd_list(cmds, count_of(cmds));
}

void SH1106_area_render(uint8_t *buf, uint8_t area_id)
{
    /* TODO */
}

void SH1106_full_render(uint8_t *buf)
{
    // update a portion of the display with a render area
	int p = 0;
    int i; 
	char height = SH1106_HEIGHT;
	char m_row = 0;
	char m_col = 2; // because internally there are 132 columns, 2 + 128 + 2 but only 128 are visible
    uint8_t cmd;

	// divide by 8
	height >>= 3;

    uint8_t cmds[] = {
        (SH1106_SETLOWCOLUMN | 0x0),
        (SH1106_SETHIGHCOLUMN | 0x0),
        (SH1106_SET_DISP_START_LINE | 0x0)
    };
    PRINT_SH1106_DEBUG("CMD=%02X\nCMD=%02X\nCMD=%02X\n",cmds[0],cmds[1],cmds[2]);
    SH1106_send_cmd_list(cmds, count_of(cmds));

	for (i = 0; i < height; i++)
    {		
		// send all the page in one shot
        // set page address
        cmd = (SH1106_SET_PAGE_ADDR + i + m_row);
        SH1106_send_cmd(cmd);
        PRINT_SH1106_DEBUG("i=%d CMD=%02X\n",i,cmd);
        // set lower column address
        cmd = (SH1106_SETLOWCOLUMN | (m_col & 0xf));
        SH1106_send_cmd(cmd);
        PRINT_SH1106_DEBUG("i=%d CMD=%02X\n",i,cmd);
        // set higher column address
        cmd = (SH1106_SETHIGHCOLUMN | (m_col >> 4));
        SH1106_send_cmd(cmd);
        PRINT_SH1106_DEBUG("i=%d CMD=%02X\n",i,cmd);
		
        // send one page in one shot
        SH1106_send_buf((uint8_t *)&buf[p], 128);
        p += 128;
	}
}

static inline void SH1106_clean_area(uint8_t *buf, uint16_t x_start,uint16_t x_end,uint16_t y_high)
{
    int i;

    if(x_start/SH1106_WIDTH == x_end/SH1106_WIDTH)
    {
        // start and end on the same line
        for(i=x_start; i<x_end; i++)
            buf[i] = 0x0;
        if(y_high == FONT_HIGH_16)
        {
            // need to cancel a second row
            x_start += SH1106_WIDTH;
            x_end += SH1106_WIDTH;
            for(i=x_start; i<x_end; i++)
                buf[i] = 0x0;
        }
    }
    else
    {
        // TODO!
    }

    return;
}

static inline int 
SH1106_get_font_index(uint8_t ch, int font_h)
{
    int idx = 0;

    if (font_h == FONT_HIGH_8)
    {
        if (ch >= 'A' && ch <='Z')
        {
            idx = ch - 'A' + 1;
        }
        else if (ch >= '0' && ch <='9')
        {
                idx = ch - '0' + 27;
        }
    }
    else if (font_h == FONT_HIGH_16)
    {
        if(ch >= ' ' && ch <= '~')
            idx = ch - ' ';
    }
    PRINT_SH1106_DEBUG("ch=%c idx=%d\n",ch,idx);

    return idx;
}


int SH1106_write_icon(uint8_t *buf, int16_t x, int16_t y, uint8_t id_icon, uint8_t font_l, uint8_t font_h)
{
    int ret = 0;
    int i, fb_idx;

    // check if character fit into display
    if ((x > (SH1106_WIDTH - font_l)) || (y > (SH1106_HEIGHT - font_h)))
    {
        ret = -1;
        return ret;
    }

    // For the moment, only write on Y row boundaries (every font_h vertical pixels)
    y = y/SH1106_PAGE_HEIGHT;
    fb_idx = y * SH1106_WIDTH + x;

    switch (font_h)
    {
    case FONT_HIGH_8:
        // in this case a character fit in one page
        break;

    case FONT_HIGH_16:
        // in this case a character fit in two pages
        // write the first page
        // 12x16 pixel
        for (i=0; i<font_l; i++) {
            buf[fb_idx++] = icons_16p12[id_icon * (font_l*2) + i];
        }
        // write the second page
        y++;
        fb_idx = y * SH1106_WIDTH + x;
        for (i=0; i<font_l; i++) {
            buf[fb_idx++] = icons_16p12[id_icon * (font_l*2) + font_l + i];
        }
        break;

    case FONT_HIGH_24:
        break;

    default:
        break;
    }

    return ret;
}

static int SH1106_write_char(uint8_t *buf, int16_t x, int16_t y, uint8_t ch, uint8_t font_l, uint8_t font_h)
{
    int ret = 0;
    int i, idx, fb_idx;

    // check if character fit into display
    if ((x > (SH1106_WIDTH - font_l)) || (y > (SH1106_HEIGHT - font_h)))
    {
        ret = -1;
        return ret;
    }

    // For the moment, only write on Y row boundaries (every font_h vertical pixels)
    y = y/SH1106_PAGE_HEIGHT;

    // for the moment the fonts high 8 are only with capital letters
    if (font_h == FONT_HIGH_8)
        ch = toupper(ch);
    idx = SH1106_get_font_index(ch, font_h);
    fb_idx = (y * SH1106_WIDTH) + x;

    switch (font_h)
    {
    case FONT_HIGH_8:
        // in this case a character fit in one page
        for (i=0; i<8; i++) {
            buf[fb_idx++] = font8[idx * 8 + i];
        }
        break;

    case FONT_HIGH_16:
        // 12x16 pixel
        // in this case a character fit in two pages
        // write the first page
        for (i=0; i<font_l; i++) {
            buf[fb_idx++] = font_16p12[idx * (font_l*2) + i];
        }
        // write the second page
        y++;
        fb_idx = y * SH1106_WIDTH + x;
        for (i=0; i<font_l; i++) {
            buf[fb_idx++] = font_16p12[idx * (font_l*2) + font_l + i];
        }
        break;

    case FONT_HIGH_24:
        break;

    default:
        break;
    }

    return ret;
}


int SH1106_write_string(uint8_t *buf, int16_t x, int16_t y, char *str, uint8_t font_w, uint8_t font_h)
{
    int ret = -1;

    // reject any string off the screen
    if( (x > (SH1106_WIDTH - font_w)) || (y > (SH1106_HEIGHT - font_h)))
        return ret;
    else 
        ret = 0;

    while(*str)
    {
        ret = SH1106_write_char(buf, x, y, *str, font_w, font_h); 
        if(ret == 0)
        {
            x += font_w;
            str++;
        }
        else
            break;
    }

    return ret;
}

int SH1106_display_temperature(uint8_t *buf,char *str, uint8_t font_l, uint8_t font_h)
{
    int ret = 0;
    uint8_t nchar = 0;
    int16_t x_start_pos = 0;
    int16_t x_start_buf = 0;

    // calculate the number of characters/icons that fit into single line
    nchar = SH1106_WIDTH / font_l;
    if(nchar < (strlen(str) + 1))
    {
        // str doesn't fit in a single line
        ret = -1;
        return ret;
    }
    PRINT_SH1106_DEBUG("nchar=%d\n",nchar);

    // calculate the position of first characters aligning to the right
    // and leave the space to the right for the icons (°C or °F).
    x_start_pos = (nchar - (strlen(str) + 1))*font_l;
    PRINT_SH1106_DEBUG("x_start_pos=%d\n",x_start_pos);
    // calculate the position in the buffer
    x_start_buf = (RT_FIRST_PAGE_INFO_T * SH1106_WIDTH) + x_start_pos;
    PRINT_SH1106_DEBUG("x_start_buf=%d\n",x_start_buf);

    // clean the line before start point to delete previous value
    // skip first character where is displayed an icon
    SH1106_clean_area(buf,((RT_FIRST_PAGE_INFO_T * SH1106_WIDTH) + font_l),x_start_buf,font_h);
    ret = SH1106_write_string(buf,x_start_pos,SH1106_PAGE_HEIGHT * RT_FIRST_PAGE_INFO_T,str,font_l,font_h); 

    return ret;
}

int SH1106_display_humidity(uint8_t *buf,char *str, uint8_t font_l, uint8_t font_h)
{
    int ret = 0;
    uint8_t nchar = 0;
    int16_t x_start_pos = 0;
    int16_t x_start_buf = 0;

    // calculate the number of characters/icons that fit into single line
    nchar = SH1106_WIDTH / font_l;
    if(nchar < (strlen(str) + 1))
    {
        // str doesn't fit in a single line
        ret = -1;
        return ret;
    }
    PRINT_SH1106_DEBUG("nchar=%d\n",nchar);

    // calculate the position of first characters aligning to the right
    // and leave the space to the right for the icons (°C or °F).
    x_start_pos = (nchar - (strlen(str) + 1))*font_l;
    PRINT_SH1106_DEBUG("x_start_pos=%d\n",x_start_pos);
    // calculate the position in the buffer
    x_start_buf = (RT_FIRST_PAGE_INFO_H * SH1106_WIDTH) + x_start_pos;
    PRINT_SH1106_DEBUG("x_start_buf=%d\n",x_start_buf);

    // clean the line before start point to delete previous value
    // skip first character where is displayed an icon
    SH1106_clean_area(buf,((RT_FIRST_PAGE_INFO_H * SH1106_WIDTH) + font_l),x_start_buf,font_h);
    ret = SH1106_write_string(buf,x_start_pos,SH1106_PAGE_HEIGHT * RT_FIRST_PAGE_INFO_H,str,font_l,font_h); 

    return ret;
}

void SH1106_display_t_stats(uint8_t *buf,int max,int min,int avg,uint8_t font_l, uint8_t font_h)
{
    uint8_t nchar = 0;
    int16_t x_start_pos = 0;
    int16_t x_start_buf = 0;
    char str_max[10];
    char str_min[10];
    char str_avg[10];

    memset(str_max,0,sizeof(str_max));
    memset(str_min,0,sizeof(str_min));
    memset(str_avg,0,sizeof(str_avg));

    sprintf(str_max,"%.02f",(float)((float)max / 100));
    sprintf(str_min,"%.02f",(float)((float)min / 100));
    sprintf(str_avg,"%.02f",(float)((float)avg / 100));

    printf("Display: MAX=%s MIN=%s AVG=%s\n",str_max,str_min,str_avg);

    // calculate the number of characters/icons that fit into single line
    nchar = SH1106_WIDTH / font_l;
    if((nchar < (strlen(str_max) + strlen(DISPLAY_LAST24H[1]))) ||
       (nchar < (strlen(str_min) + strlen(DISPLAY_LAST24H[0]))) ||
       (nchar < (strlen(str_avg) + strlen(DISPLAY_LAST24H[2]))))
    {
        // one of the strings doesn't fit in a single line
        printf("%s - Error in str len\n",__FUNCTION__);
        return;
    }
    PRINT_SH1106_DEBUG("nchar=%d\n",nchar);

    // MIN
    // calculate the position of first characters aligning to the right
    // and leave the space to the right for the icons (°C or °F).
    x_start_pos = (nchar - (strlen(str_min) + 1))*font_l;
    PRINT_SH1106_DEBUG("x_start_pos=%d\n",x_start_pos);
    // calculate the position in the buffer
    x_start_buf = (L24_T_FIRST_PAGE_INFO_MIN_T * SH1106_WIDTH) + x_start_pos;
    PRINT_SH1106_DEBUG("x_start_buf=%d\n",x_start_buf);
    // clean the line before start point to delete previous value
    // skip first character where is displayed an icon
    SH1106_clean_area(buf,((L24_T_FIRST_PAGE_INFO_MIN_T * SH1106_WIDTH) + (font_l * strlen(DISPLAY_LAST24H[0]))),x_start_buf,font_h);
    SH1106_write_string(buf,x_start_pos,SH1106_PAGE_HEIGHT * L24_T_FIRST_PAGE_INFO_MIN_T,str_min,font_l,font_h); 

    // MAX
    // calculate the position of first characters aligning to the right
    // and leave the space to the right for the icons (°C or °F).
    x_start_pos = (nchar - (strlen(str_max) + 1))*font_l;
    PRINT_SH1106_DEBUG("x_start_pos=%d\n",x_start_pos);
    // calculate the position in the buffer
    x_start_buf = (L24_T_FIRST_PAGE_INFO_MAX_T * SH1106_WIDTH) + x_start_pos;
    PRINT_SH1106_DEBUG("x_start_buf=%d\n",x_start_buf);
    // clean the line before start point to delete previous value
    // skip first character where is displayed an icon
    SH1106_clean_area(buf,((L24_T_FIRST_PAGE_INFO_MAX_T * SH1106_WIDTH) + (font_l * strlen(DISPLAY_LAST24H[1]))),x_start_buf,font_h);
    SH1106_write_string(buf,x_start_pos,SH1106_PAGE_HEIGHT *L24_T_FIRST_PAGE_INFO_MAX_T,str_max,font_l,font_h); 

    // AVG
    // calculate the position of first characters aligning to the right
    // and leave the space to the right for the icons (°C or °F).
    x_start_pos = (nchar - (strlen(str_avg) + 1))*font_l;
    PRINT_SH1106_DEBUG("x_start_pos=%d\n",x_start_pos);
    // calculate the position in the buffer
    x_start_buf = (L24_T_FIRST_PAGE_INFO_AVG_T * SH1106_WIDTH) + x_start_pos;
    PRINT_SH1106_DEBUG("x_start_buf=%d\n",x_start_buf);
    // clean the line before start point to delete previous value
    // skip first character where is displayed an icon
    SH1106_clean_area(buf,((L24_T_FIRST_PAGE_INFO_AVG_T * SH1106_WIDTH) + (font_l * strlen(DISPLAY_LAST24H[2]))),x_start_buf,font_h);
    SH1106_write_string(buf,x_start_pos,SH1106_PAGE_HEIGHT * L24_T_FIRST_PAGE_INFO_AVG_T,str_avg,font_l,font_h); 

    return;
}

void SH1106_display_h_stats(uint8_t *buf,int max,int min,int avg,uint8_t font_l, uint8_t font_h)
{
    SH1106_display_t_stats(buf,max,min,avg,font_l,font_h);
    return;
}

void SH1106_setup_display_layout(uint8_t *buf, int fb_size, uint8_t mode)
{
#if 0    
    int i;
#endif

    // cleanup the buffer
    memset(buf, 0, fb_size);

    // build the entire display layout according to the mode requested
    switch(mode)
    {
        case DISPLAY_MODE_RT_MES:
            // __________________
            // |________________|   1 page  - blank (future use)
            // |                |   2 pages - Description Area
            // |________________|
            // |                |   2 pages - TEMPERATURE INFO
            // |________________|
            // |                |   2 pages - HUMIDITY INFO
            // |________________|   
            // |________________|   1 page  - blank (future use) 
            // 
            // add description for this mode
            SH1106_write_string(buf, 16, DSPLY_MODE_RT_MES_DESCR_Y, DISPLAY_DESCR[mode],FONT_WIDTH_12,FONT_HIGH_16);
            // add icons to the Info Area
            SH1106_write_icon(buf, 0, DSPLY_MODE_RT_MES_ICONT_Y, SH1106_ICON_TERMOMETER, FONT_WIDTH_12, FONT_HIGH_16);
            SH1106_write_icon(buf, (SH1106_WIDTH - FONT_WIDTH_12), DSPLY_MODE_RT_MES_ICONT_Y, SH1106_ICON_CELSIUS, FONT_WIDTH_12, FONT_HIGH_16);
            SH1106_write_icon(buf, 0, DSPLY_MODE_RT_MES_ICONH_Y, SH1106_ICON_DROP, FONT_WIDTH_12, FONT_HIGH_16);
            SH1106_write_icon(buf, (SH1106_WIDTH - FONT_WIDTH_12), DSPLY_MODE_RT_MES_ICONH_Y, SH1106_ICON_PERCENT, FONT_WIDTH_12, FONT_HIGH_16);
            break;

        case DISPLAY_MODE_SHOW_LAST_24H_T:
            // __________________
            // |                |   2 pages - Description Area
            // |________________|
            // |                |   2 pages - MIN TEMP   
            // |________________|
            // |                |   2 pages - MAX TEMP
            // |________________|
            // |                |   2 pages - AVG TEMP
            // |________________|   
            // 
            // add description for this mode
            SH1106_write_string(buf, 0, DSPLY_MODE_LAST24H_T_DES_Y, DISPLAY_DESCR[mode],FONT_WIDTH_12,FONT_HIGH_16);
            SH1106_write_string(buf, 0, DSPLY_MODE_LAST24H_T_MIN_Y, DISPLAY_LAST24H[0],FONT_WIDTH_12,FONT_HIGH_16);
            SH1106_write_icon(buf, (SH1106_WIDTH - FONT_WIDTH_12), DSPLY_MODE_LAST24H_T_MIN_Y, SH1106_ICON_CELSIUS, FONT_WIDTH_12, FONT_HIGH_16);          
            SH1106_write_string(buf, 0, DSPLY_MODE_LAST24H_T_MAX_Y, DISPLAY_LAST24H[1],FONT_WIDTH_12,FONT_HIGH_16);
            SH1106_write_icon(buf, (SH1106_WIDTH - FONT_WIDTH_12), DSPLY_MODE_LAST24H_T_MAX_Y, SH1106_ICON_CELSIUS, FONT_WIDTH_12, FONT_HIGH_16);
            SH1106_write_string(buf, 0, DSPLY_MODE_LAST24H_T_AVG_Y, DISPLAY_LAST24H[2],FONT_WIDTH_12,FONT_HIGH_16);            
            SH1106_write_icon(buf, (SH1106_WIDTH - FONT_WIDTH_12), DSPLY_MODE_LAST24H_T_AVG_Y, SH1106_ICON_CELSIUS, FONT_WIDTH_12, FONT_HIGH_16);
            break;
        
        case DISPLAY_MODE_SHOW_LAST_24H_H:
            // __________________
            // |                |   2 pages - Description Area
            // |________________|
            // |                |   2 pages - MIN HUMIDITY   
            // |________________|
            // |                |   2 pages - MAX HUMIDITY
            // |________________|
            // |                |   2 pages - AVG HUMIDITY
            // |________________|   
            // 
            // add description for this mode
            SH1106_write_string(buf, 0, DSPLY_MODE_LAST24H_H_DES_Y, DISPLAY_DESCR[mode],FONT_WIDTH_12,FONT_HIGH_16);
            SH1106_write_string(buf, 0, DSPLY_MODE_LAST24H_H_MIN_Y, DISPLAY_LAST24H[0],FONT_WIDTH_12,FONT_HIGH_16);
            SH1106_write_icon(buf, (SH1106_WIDTH - FONT_WIDTH_12), DSPLY_MODE_LAST24H_H_MIN_Y, SH1106_ICON_PERCENT, FONT_WIDTH_12, FONT_HIGH_16);
            SH1106_write_string(buf, 0, DSPLY_MODE_LAST24H_H_MAX_Y, DISPLAY_LAST24H[1],FONT_WIDTH_12,FONT_HIGH_16);
            SH1106_write_icon(buf, (SH1106_WIDTH - FONT_WIDTH_12), DSPLY_MODE_LAST24H_H_MAX_Y, SH1106_ICON_PERCENT, FONT_WIDTH_12, FONT_HIGH_16);
            SH1106_write_string(buf, 0, DSPLY_MODE_LAST24H_H_AVG_Y, DISPLAY_LAST24H[2],FONT_WIDTH_12,FONT_HIGH_16);
            SH1106_write_icon(buf, (SH1106_WIDTH - FONT_WIDTH_12), DSPLY_MODE_LAST24H_H_AVG_Y, SH1106_ICON_PERCENT, FONT_WIDTH_12, FONT_HIGH_16);
            break;
        
        default:
            PRINT_SH1106_DEBUG("Unknown display mode (%d)\n", mode);
            break;
    }

    return;
}

void SH1106_show_boot_info(uint8_t *buf,int fb_size,char *prg_vers,char *sens_type)
{
    char boot_string[16];

    memset(buf, 0, fb_size);
    memset(boot_string,0,sizeof(boot_string));
    sprintf(boot_string,"Vers %s",prg_vers);
    SH1106_write_string(buf,8,24,boot_string,FONT_HIGH_8,FONT_HIGH_8);
    memset(boot_string,0,sizeof(boot_string));
    sprintf(boot_string,"Sens %s",sens_type);
    SH1106_write_string(buf,8,40,boot_string,FONT_HIGH_8,FONT_HIGH_8);

    return;
}

